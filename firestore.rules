rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if user is agent
    function isAgent() {
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'agent';
    }

    // Users Collection
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin() || isAgent());
      
      // Create: Allow if Admin OR (Owner AND role is 'client')
      // This prevents a user from signing up directly as 'admin' or 'agent'
      allow create: if request.auth != null && (
        isAdmin() || 
        (request.auth.uid == userId && (!('role' in request.resource.data) || request.resource.data.role == 'client'))
      );

      // Update: Allow if Admin OR (Owner AND NOT changing the role)
      // This prevents a user from upgrading their role after creation
      allow update: if request.auth != null && (
        isAdmin() || 
        (request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']))
      );

      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // Policies & Sub-Categories (Admin/Agent access mostly)
    match /sub-categories/{document=**} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Policies (Top-level collection)
    match /policies/{policyId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // --- Collection Group Queries ---
    // Explicitly allow Admin/Agent to query ALL vehicles across the database
    match /{path=**}/vehicles/{vehicleId} {
      allow read: if request.auth != null && (isAdmin() || isAgent());
    }
    // Explicitly allow authenticated users to query ALL policies
    match /{path=**}/policies/{policyId} {
      allow read: if request.auth != null;
    }

    // Assets (Vehicles)
    match /assets/{userId}/vehicles/{vehicleId} {
      allow get: if request.auth != null && (resource.data.uid == request.auth.uid || isAdmin() || isAgent());
      allow list: if request.auth != null && (isAdmin() || isAgent() || request.auth.uid == userId);

      // Create: Must be authenticated and assigning the vehicle to themselves (unless Admin/Agent)
      allow create: if request.auth != null && (request.auth.uid == userId || isAdmin() || isAgent());
      
      allow update: if request.auth != null && (resource.data.uid == request.auth.uid || isAdmin() || isAgent());
      allow delete: if request.auth != null && (resource.data.uid == request.auth.uid || isAdmin());
    }

    // Invoices
    match /invoices/{invoiceId} {
      // Allow read if Admin, Agent, or if the invoice belongs to the user (clientId matches uid)
      allow read: if request.auth != null && (isAdmin() || isAgent() || resource.data.clientId == request.auth.uid);
      allow create: if request.auth != null && (isAdmin() || isAgent());
      allow update, delete: if isAdmin();
    }

    // Notifications & Messaging
    
    // 1. Users can read/write their own entire notification hierarchy
    match /notifications/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // 2. Allow authenticated users to WRITE (create) to another user's "received" collection
    // The path structure is: /notifications/{recipientId}/received/{senderId}/messages/{messageId}
    match /notifications/{recipientId}/received/{senderId}/messages/{messageId} {
      allow create: if request.auth != null && request.auth.uid == senderId;
    }
  }
}