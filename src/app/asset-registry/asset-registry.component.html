<!-- HEADER -->
<div class="header">
    <h1>Manage Client Assets</h1>
    <button class="btn-create" (click)="openAddAssetModal()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20">
            <path d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" />
        </svg>
        Add Assets
    </button>
</div>

<div class="container">
    <!-- FILTERS -->
    <div class="filters">
        <div class="filter-group">
            <label class="filter-label">Search</label>
            <input type="text" placeholder="Asset Name or Client" class="filter-select" style="min-width: 200px;">
        </div>
        <div class="filter-group">
            <label class="filter-label">Status</label>
            <select class="filter-select">
                <option>All</option>
                <option>Active</option>
                <option>Pending</option>
                <option>Retired</option>
            </select>
        </div>
        <div class="filter-group">
            <label class="filter-label">Type</label>
            <select class="filter-select">
                <option>All</option>
                <option>Vehicle</option>
                <option>Property</option>
                <option>Equipment</option>
            </select>
        </div>
    </div>

    <!-- ASSET TABLE -->
    <div class="asset-table-card">
        <table class="asset-table">
            <thead>
                <tr>
                    <th>Asset</th>
                    <th>Client</th>
                    <th>Status</th>
                    <th class="text-right">Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngIf="isLoading">
                    <td colspan="4">
                        <div class="loading-spinner-container">
                            <div class="loading-spinner"></div>
                        </div>
                    </td>
                </tr>
                <tr *ngFor="let asset of assets" [hidden]="isLoading">
                    <td>
                        <div class="asset-info">
                            <div class="asset-avatar">{{ asset.assetName?.charAt(0) || 'A' }}</div>
                            <span>{{ asset.assetName }} <span style="color: #86868b; font-size: 12px;">({{ asset.type
                                    }})</span></span>
                        </div>
                    </td>
                    <td>{{ asset.clientName || 'N/A' }}</td>
                    <td><span class="status" [ngClass]="asset.status?.toLowerCase()">{{ asset.status | titlecase
                            }}</span></td>
                    <td class="actions">
                        <button class="btn-icon" (click)="openViewModal(asset)" title="Edit Asset">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20"
                                height="20">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                            </svg>
                        </button>
                        <button class="btn-icon delete" (click)="onDeleteAsset(asset)" title="Delete Asset"
                            style="color: #ef4444;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20"
                                height="20">
                                <path fill-rule="evenodd"
                                    d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                                    clip-rule="evenodd" />
                            </svg>
                        </button>
                    </td>
                </tr>
                <tr *ngIf="!isLoading && assets.length === 0">
                    <td colspan="4" style="text-align: center; padding: 24px; color: #86868b;">No assets found.</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- MODALS -->

<!-- View Asset Modal -->
<div class="modal-overlay" *ngIf="isViewModalOpen && selectedAsset">
    <div class="modal-card">
        <div class="modal-header">
            <h2>Edit Asset: {{ selectedAsset.assetName }}</h2>
            <button class="btn-close" (click)="closeViewModal()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20">
                    <path
                        d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                </svg>
            </button>
        </div>
        <form class="modal-body" [formGroup]="editAssetForm" (ngSubmit)="onUpdateAsset()">
            <div class="detail-section">
                <h4>Basic Information</h4>
                <div class="detail-grid">
                    <div class="detail-item"><label>Make & Model</label>
                        <p>{{ selectedAsset.make }}</p>
                    </div>
                    <div class="detail-item"><label>Year</label>
                        <p>{{ selectedAsset.year }}</p>
                    </div>
                    <div class="detail-item"><label>Number Plate</label>
                        <p>{{ selectedAsset.numberPlate }}</p>
                    </div>
                    <div class="detail-item"><label>VIN</label>
                        <p>{{ selectedAsset.vin }}</p>
                    </div>
                    <div class="detail-item"><label>Body Type</label>
                        <p>{{ selectedAsset.bodyType }}</p>
                    </div>
                    <div class="detail-item"><label>Vehicle Class</label>
                        <p>{{ selectedAsset.vehicleClass }}</p>
                    </div>
                    <div class="detail-item"><label>Primary Use</label>
                        <p>{{ selectedAsset.primaryUse }}</p>
                    </div>
                    <div class="detail-item"><label>Garaging Address</label>
                        <p>{{ selectedAsset.garagingAddress }}</p>
                    </div>
                    <div class="detail-item"><label>Status</label>
                        <span class="status" [ngClass]="selectedAsset.status?.toLowerCase()">{{ selectedAsset.status ||
                            'Pending' }}</span>
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <h4>Compliance & Safety</h4>
                <div class="detail-grid">
                    <div class="field">
                        <label>Asset Value ($)</label>
                        <input type="number" formControlName="assetValue" class="form-input" />
                    </div>
                    <div class="field">
                        <label>Safety Features</label>
                        <select formControlName="safetyFeatures" class="form-select">
                            <option value="">Select Features</option>
                            <option value="Alarm">Alarm</option>
                            <option value="Immobilizer">Immobilizer</option>
                            <option value="Tracking Device">Tracking Device</option>
                            <option value="Steering Lock">Steering Lock</option>
                            <option value="None">None</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Policy Deployment</label>
                        <input type="date" formControlName="policyDeploymentDate" class="form-input" />
                    </div>
                    <div class="field">
                        <label>Policy Expiry</label>
                        <input type="date" formControlName="policyExpiryDate" class="form-input" />
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <h4>Policies</h4>
                <table class="asset-table" style="margin-top: 0;">
                    <thead>
                        <tr>
                            <th>Policy ID</th>
                            <th>Type</th>
                            <th>Sum Assured</th>
                            <th>Tenure</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let policy of selectedAsset.policies">
                            <td>{{ policy.policyId }}</td>
                            <td>{{ policy.policyType }}</td>
                            <td>{{ policy.sumAssured | currency }}</td>
                            <td>{{ policy.tenureMonths }} months</td>
                            <td><span class="status" [ngClass]="policy.status?.toLowerCase()">{{ policy.status |
                                    titlecase }}</span></td>
                        </tr>
                        <tr *ngIf="!selectedAsset.policies || selectedAsset.policies.length === 0">
                            <td colspan="5" style="text-align: center; color: #86868b;">No policies found.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Asset Documentation Section -->
            <div class="detail-section">
                <h4>Asset Documentation</h4>
                
                <!-- File Uploads for Updates -->
                <div class="detail-grid" style="margin-bottom: 20px;">
                    <div class="field">
                        <label>Update Vehicle Registration Book</label>
                        <input type="file" (change)="onEditFileChange($event, 'vehicleRegistrationBook')" accept=".pdf,.jpg,.png" />
                    </div>
                    <div class="field">
                        <label>Update Radio License</label>
                        <input type="file" (change)="onEditFileChange($event, 'radioLicense')" accept=".pdf,.jpg,.png" />
                    </div>
                    <div class="field">
                        <label>Update Driver's License</label>
                        <input type="file" (change)="onEditFileChange($event, 'driversLicense')" accept="image/*" />
                    </div>
                    <div class="field">
                        <label>Update Insurance Policy</label>
                        <input type="file" (change)="onEditFileChange($event, 'insurancePolicy')" accept=".pdf,.jpg,.png" />
                    </div>
                    <div class="field">
                        <label>Update Vehicle Documentation</label>
                        <input type="file" (change)="onEditFileChange($event, 'vehicleDocumentation')" accept=".pdf,.jpg,.png" />
                    </div>
                </div>

                <div *ngIf="selectedAsset.documents && selectedAsset.documents.length > 0" class="documents-grid">
                    <div *ngFor="let doc of selectedAsset.documents" class="document-item">
                        <div class="document-preview">
                            <img *ngIf="doc.type?.startsWith('image/')" [src]="doc.dataUrl" alt="{{doc.field}}"
                                class="doc-thumbnail">
                            <div *ngIf="!doc.type?.startsWith('image/')" class="doc-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                    width="48" height="48">
                                    <path fill-rule="evenodd"
                                        d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"
                                        clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div class="document-info">
                            <h5>{{ doc.field || doc.name }}</h5>
                            <p class="doc-name">{{ doc.name }}</p>
                            <a *ngIf="doc.dataUrl" [href]="doc.dataUrl" [download]="doc.name" class="doc-download">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                    width="16" height="16">
                                    <path fill-rule="evenodd"
                                        d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                                        clip-rule="evenodd" />
                                </svg>
                                Download
                            </a>
                        </div>
                    </div>
                </div>
                <p *ngIf="!selectedAsset.documents || selectedAsset.documents.length === 0" class="no-documents">
                    No documents attached to this asset
                </p>
            </div>

            <!-- Footer Actions -->
            <div class="modal-footer" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <!-- Approval Button (Only for non-Active assets) -->
                <button type="button" class="btn-approve" *ngIf="selectedAsset.status !== 'Active'" (click)="openApprovalModal(selectedAsset)">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    Approve
                </button>

                <!-- Submit Button -->
                <button type="submit" class="btn-primary" [disabled]="isSubmitting">
                    <span *ngIf="isSubmitting" class="spinner"></span>
                    {{ isSubmitting ? 'Saving...' : 'Save Changes' }}
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Asset Modal -->
<div class="modal-overlay" *ngIf="isAddAssetModalOpen">
    <div class="modal-card">
        <div class="modal-header">
            <h2>Add New Asset</h2>
            <button class="btn-close" (click)="closeAddAssetModal()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20">
                    <path
                        d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                </svg>
            </button>
        </div>
        <form class="modal-body" [formGroup]="addAssetForm" (ngSubmit)="onAddAsset()">
            <div formArrayName="vehicles">
                <div *ngFor="let vehicle of vehicles.controls; let i = index" [formGroupName]="i"
                    class="vehicle-form-group"
                    style="margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px;">

                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; font-size: 16px; color: #0071e3;">Vehicle {{ i + 1 }}</h3>
                        <button type="button" class="btn-icon" (click)="removeVehicle(i)" *ngIf="vehicles.length > 1"
                            title="Remove Vehicle" style="color: #dc2626;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20"
                                height="20">
                                <path fill-rule="evenodd"
                                    d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                                    clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>

                    <!-- SECTION 1: BASIC INFORMATION -->
                    <div class="detail-section">
                        <h4>Vehicle Registration – Basic Information</h4>
                        <p style="font-size: 12px; color: #86868b; margin-bottom: 15px;">Provide essential details about
                            your vehicle.</p>

                        <div class="detail-grid">
                            <div class="field">
                                <label>Make & Model</label>
                                <input type="text" formControlName="make" placeholder="e.g. Toyota Corolla" />
                            </div>
                            <div class="field">
                                <label>Date of Manufacture / Registration</label>
                                <input type="date" formControlName="manufactureDate" />
                            </div>
                            <div class="field">
                                <label>Number Plate</label>
                                <input type="text" formControlName="numberPlate" placeholder="e.g. EEA-2556" />
                            </div>
                            <div class="field">
                                <label>VIN</label>
                                <input type="text" formControlName="vin" placeholder="Vehicle Identification Number" />
                            </div>
                            <div class="field">
                                <label>Body Type</label>
                                <select formControlName="bodyType">
                                    <option value="">Select Body Type</option>
                                    <option value="Sedan">Sedan</option>
                                    <option value="SUV">SUV</option>
                                    <option value="Hatchback">Hatchback</option>
                                    <option value="Truck">Truck</option>
                                    <option value="Van">Van</option>
                                    <option value="Motorcycle">Motorcycle</option>
                                </select>
                            </div>
                            <div class="field">
                                <label>Vehicle Class</label>
                                <select formControlName="vehicleClass">
                                    <option value="">Select Class</option>
                                    <option value="Class 1">Class 1 (Buses/Omnibuses)</option>
                                    <option value="Class 2">Class 2 (Heavy Vehicles)</option>
                                    <option value="Class 3">Class 3 (Light Motor Vehicles)</option>
                                    <option value="Class 4">Class 4 (Motorcycles)</option>
                                    <option value="Class 5">Class 5 (Construction/Farm)</option>
                                </select>
                            </div>
                            <div class="field">
                                <label>Primary Use</label>
                                <input type="text" formControlName="primaryUse" placeholder="e.g. Pleasure" />
                            </div>
                            <div class="field">
                                <label>Garaging Address</label>
                                <input type="text" formControlName="garagingAddress"
                                    placeholder="e.g. 30 J.Chinamano Hare" />
                            </div>
                            <div class="field" style="grid-column: span 2;">
                                <label>Safety / Anti-theft Features</label>
                                <select formControlName="safetyFeatures">
                                    <option value="">Select Features</option>
                                    <option value="Alarm">Alarm</option>
                                    <option value="Immobilizer">Immobilizer</option>
                                    <option value="Tracking Device">Tracking Device</option>
                                    <option value="Steering Lock">Steering Lock</option>
                                    <option value="None">None</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 2: COMPLIANCE & DOCUMENTS -->
                    <div class="detail-section" style="margin-top: 20px;">
                        <h4>Vehicle Registration – Compliance & Documents</h4>
                        <p style="font-size: 12px; color: #86868b; margin-bottom: 15px;">Upload required documents and
                            specify vehicle value.</p>

                        <div class="detail-grid">
                            <div class="field">
                                <label>Asset Value ($)</label>
                                <input type="number" formControlName="assetValue" placeholder="e.g. 18000" />
                            </div>
                            <div class="field">
                                <label>Vehicle Registration Book</label>
                                <input type="file" (change)="onFileChange($event, i, 'vehicleRegistrationBook')"
                                    accept=".pdf,.jpg,.png" />
                            </div>
                            <div class="field">
                                <label>Radio License</label>
                                <input type="file" (change)="onFileChange($event, i, 'radioLicense')"
                                    accept=".pdf,.jpg,.png" />
                            </div>
                            <div class="field">
                                <label>Driver's License Image</label>
                                <input type="file" (change)="onFileChange($event, i, 'driversLicense')"
                                    accept="image/*" />
                            </div>
                            <div class="field">
                                <label>Vehicle Documentation (General)</label>
                                <input type="file" (change)="onFileChange($event, i, 'vehicleDocumentation')"
                                    accept=".pdf,.jpg,.png" />
                            </div>
                        </div>

                        <h5
                            style="font-size: 12px; font-weight: 600; color: #86868b; margin: 15px 0 10px 0; text-transform: uppercase;">
                            Insurance Policy Details</h5>
                        <div class="detail-grid">
                            <div class="field">
                                <label>Insurance Policy Document</label>
                                <input type="file" (change)="onFileChange($event, i, 'insurancePolicy')"
                                    accept=".pdf,.jpg,.png" />
                            </div>
                            <div class="field">
                                <label>Policy Deployment Date</label>
                                <input type="date" formControlName="policyDeploymentDate" />
                            </div>
                            <div class="field">
                                <label>Policy Expiry Date</label>
                                <input type="date" formControlName="policyExpiryDate" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <button type="button" class="btn-secondary" (click)="addVehicle()"
                    style="width: 100%; border: 1px dashed #d2d2d7;">
                    + Add Another Vehicle
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" (click)="closeAddAssetModal()"
                    [disabled]="isSubmitting">Cancel</button>
                <button type="submit" class="btn-primary" [disabled]="addAssetForm.invalid || isSubmitting">
                    <span *ngIf="isSubmitting" class="spinner"></span>
                    {{ isSubmitting ? 'Saving...' : 'Add Asset' }}
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Approval Modal -->
<div class="modal-overlay" *ngIf="isApprovalModalOpen">
    <div class="modal-card modal-small">
        <div class="modal-header">
            <h2>Approve Asset</h2>
            <button class="btn-close" (click)="closeApprovalModal()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20">
                    <path
                        d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="approval-info" *ngIf="pendingApprovalAsset">
                <p><strong>Asset:</strong> {{ pendingApprovalAsset.assetName }}</p>
                <p><strong>Client:</strong> {{ pendingApprovalAsset.clientName }}</p>
            </div>
            <div class="field">
                <label>Assured Value ($)</label>
                <input type="number" [(ngModel)]="assuredValue" placeholder="Enter assured value" min="0" step="100">
                <p class="field-hint">Set the insured/assured value for this asset</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" (click)="closeApprovalModal()">Cancel</button>
            <button type="button" class="btn-primary" (click)="onSendApproval()" [disabled]="assuredValue <= 0">
                Send Approval
            </button>
        </div>
    </div>
</div>