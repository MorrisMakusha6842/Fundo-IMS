<div class="notifications-container" [class.chat-active]="!!selectedUser">

    <!-- LEFT PANEL: USERS LIST -->
    <aside class="users-panel">
        <div class="panel-header">
            Conversations
        </div>

        <ul class="users-list">
            <li *ngIf="isLoadingUsers" class="user-item">
                <div class="loading-text">Loading users...</div>
            </li>

            <li *ngFor="let user of users" class="user-item" [class.active]="selectedUser?.uid === user.uid"
                (click)="selectUser(user)">
                <div class="user-avatar">
                    <img *ngIf="user.avatarDataUrl" [src]="user.avatarDataUrl" alt="{{user.displayName}}">
                    <span *ngIf="!user.avatarDataUrl" class="user-initials">{{getUserInitials(user)}}</span>
                </div>
                <div class="user-info">
                    <p class="user-name">{{user.displayName || user.email || 'Unknown User'}}</p>
                    <p class="last-message">{{user.role || 'Client'}}</p>
                </div>

                <!-- Unread Badge -->
                <div class="unread-badge" *ngIf="unreadCounts[user.uid] > 0">
                    {{ unreadCounts[user.uid] > 99 ? '99+' : unreadCounts[user.uid] }}
                </div>
            </li>

            <li *ngIf="!isLoadingUsers && users.length === 0" class="user-item">
                <div class="loading-text">No users found</div>
            </li>
        </ul>
    </aside>

    <!-- RIGHT PANEL: CHAT -->
    <section class="chat-panel" *ngIf="selectedUser">

        <!-- CHAT HEADER -->
        <header class="chat-header">
            <button class="back-btn" (click)="backToUsers()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
            </button>
            <div class="header-user-avatar">
                <img *ngIf="selectedUser.avatarDataUrl" [src]="selectedUser.avatarDataUrl"
                    alt="{{selectedUser.displayName}}">
                <span *ngIf="!selectedUser.avatarDataUrl" class="user-initials">{{getUserInitials(selectedUser)}}</span>
            </div>
            <div class="header-user-info">
                <p class="header-user-name">{{selectedUser.displayName || selectedUser.email}}</p>
                <p class="header-user-status">{{selectedUser.role || 'User'}}</p>
            </div>
            <!-- Message Filter -->
            <div class="message-filters" *ngIf="selectedUser.uid !== 'system'">
                <button [class.active]="messageFilter === 'all'" (click)="setFilter('all')">All</button>
                <button [class.active]="messageFilter === 'read'" (click)="setFilter('read')">Read</button>
                <button [class.active]="messageFilter === 'unread'" (click)="setFilter('unread')">Unread</button>
            </div>
        </header>

        <!-- CHAT MESSAGES (Scrollable) -->
        <main class="messages-area" #scrollContainer>
            <div *ngIf="isLoadingMessages" class="loading-text">Loading messages...</div>

            <div *ngIf="!isLoadingMessages && allMessages.length === 0" class="no-messages">
                {{ (selectedUser.uid === 'system') ? 'No notifications.' : 'No messages yet. Start the
                conversation!' }}
            </div>

            <div *ngIf="!isLoadingMessages && allMessages.length > 0 && filteredMessages.length === 0"
                class="no-messages">
                No {{ messageFilter }} messages found.
            </div>

            <ng-container *ngFor="let message of filteredMessages; let i = index">
                <!-- Date Separator -->
                <div class="date-separator" *ngIf="shouldShowDateSeparator(message, filteredMessages[i-1])">
                    <span>{{ getDateLabel(message.timestamp) }}</span>
                </div>

                <div class="message-wrapper" [class.sent]="message.senderId !== selectedUser.uid"
                    [class.received]="message.senderId === selectedUser.uid">
                    <div class="message-bubble" [style.background]="message.type === 'invoice' ? '#f5f5f7' : ''"
                        [style.color]="message.type === 'invoice' ? '#1d1d1f' : ''"
                        [style.border]="message.type === 'invoice' ? '1px solid #e5e5ea' : ''">

                        <!-- Invoice Message Type -->
                        <div *ngIf="message.type === 'invoice'" class="invoice-message">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #e5e5ea; padding-bottom: 8px;">
                                <strong style="font-size: 13px;">Invoice
                                    #{{message.invoiceData?.id?.substring(0,8)}}</strong>
                                <span
                                    style="font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #fef9c3; color: #854d0e;">{{message.invoiceData?.status}}</span>
                            </div>
                            <p style="margin: 0 0 8px 0; font-size: 14px;">{{message.invoiceData?.description ||
                                message.text}}</p>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600; font-size: 15px;">{{message.invoiceData?.amount |
                                    currency}}</span>
                                <button
                                    style="background: #0071e3; color: white; border: none; padding: 4px 12px; border-radius: 12px; font-size: 12px; cursor: pointer;"
                                    (click)="openVerifyModal(message.invoiceData)">Verify</button>
                            </div>
                        </div>

                        <!-- Asset Message Type -->
                        <div *ngIf="message.type === 'asset'" class="invoice-message">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #e5e5ea; padding-bottom: 8px;">
                                <strong style="font-size: 13px;">New Asset</strong>
                                <span
                                    style="font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #fff7ed; color: #c2410c;">Pending</span>
                            </div>
                            <p style="margin: 0 0 8px 0; font-size: 14px;">{{message.text}}</p>
                            <div style="display: flex; justify-content: flex-end;">
                                <button
                                    style="background: #0071e3; color: white; border: none; padding: 4px 12px; border-radius: 12px; font-size: 12px; cursor: pointer;"
                                    (click)="viewAsset(message.assetId)">Verify</button>
                            </div>
                        </div>

                        <!-- Standard Text Message -->
                        <p *ngIf="!message.type || message.type === 'text'" class="message-text">{{message.text}}</p>

                        <span class="message-time">{{message.timestamp | date:'shortTime'}}</span>
                    </div>
                </div>
            </ng-container>
        </main>

        <!-- MESSAGE INPUT (Sticky at bottom) -->
        <footer class="message-input-footer">
            <input type="text" [(ngModel)]="newMessage" (keyup.enter)="sendMessage()"
                [placeholder]="(selectedUser.uid === 'system') ? 'System notifications are read-only' : 'Type a message...'"
                class="message-input" [disabled]="selectedUser.uid === 'system'" />
            <button class="send-button" (click)="sendMessage()"
                [disabled]="!newMessage.trim() || selectedUser.uid === 'system'">
                Send
            </button>
        </footer>

    </section>

    <!-- PLACEHOLDER WHEN NO USER SELECTED -->
    <section class="chat-panel placeholder" *ngIf="!selectedUser">
        <div class="placeholder-content">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="1.5">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <p>Select a conversation to start messaging</p>
        </div>
    </section>
</div>

<!-- VERIFY MODAL -->
<div class="modal-overlay" *ngIf="isVerifyModalOpen" (click)="closeVerifyModal()">
    <div class="modal-content verify-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Verify Payment & Issue Policy</h3>
            <button class="close-icon" (click)="closeVerifyModal()">&times;</button>
        </div>

        <div class="modal-body" *ngIf="selectedInvoice">
            <div class="details-grid">
                <!-- Client Data -->
                <div class="detail-card">
                    <h4>Client Details</h4>
                    <p><span class="label">Name:</span> {{selectedInvoice.clientName || 'Unknown'}}</p>
                    <p><span class="label">Client ID:</span> <span class="mono">{{selectedInvoice.clientId}}</span></p>
                </div>

                <!-- Asset Data -->
                <div class="detail-card">
                    <h4>Asset Details</h4>
                    <p><span class="label">Asset:</span> {{selectedInvoice.assetName}}</p>
                    <p><span class="label">Asset ID:</span> <span class="mono">{{selectedInvoice.assetId}}</span></p>
                </div>

                <!-- Payment Data -->
                <div class="detail-card">
                    <h4>Payment Details</h4>
                    <p><span class="label">Amount:</span> <span class="amount">{{selectedInvoice.amount | currency}}</span></p>
                    <p><span class="label">Date:</span> {{getInvoiceDate(selectedInvoice) | date:'medium'}}</p>
                    <p><span class="label">Status:</span> <span class="status-badge">{{selectedInvoice.status}}</span></p>
                </div>
            </div>

            <!-- Duration Section -->
            <div class="detail-card" style="margin-bottom: 16px;">
                <h4>Policy Duration</h4>
                <div class="duration-controls">
                    <input type="number" [(ngModel)]="policyDuration" min="1" class="duration-input">
                    <select [(ngModel)]="policyDurationUnit" class="duration-select">
                        <option value="weeks">Weeks</option>
                        <option value="months">Months</option>
                        <option value="years">Years</option>
                    </select>
                </div>
                <p class="expiry-preview">Expires on: <strong>{{ calculateExpiryPreview() | date:'mediumDate' }}</strong></p>
            </div>

            <!-- Upload Section -->
            <div class="upload-section">
                <h4>Upload Policy Document</h4>
                <p class="upload-hint">Please upload the signed policy document or payment proof to complete verification.</p>

                <div class="upload-controls" *ngIf="!policyPreview">
                    <button class="btn-upload" (click)="fileInput.click()">Upload Image</button>
                    <input #fileInput type="file" (change)="onPolicyFileSelected($event)" accept="image/*" hidden>
                    <span class="divider">or</span>
                    <button class="btn-camera" (click)="openCameraModal()">Take Photo</button>
                </div>

                <div class="preview-container" *ngIf="policyPreview">
                    <img [src]="policyPreview" alt="Policy Preview">
                    <button class="remove-btn" (click)="removePolicyFile()">Remove</button>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="cancel-btn" (click)="closeVerifyModal()">Cancel</button>
            <button class="confirm-btn" (click)="confirmVerify()" [disabled]="!policyFile || isVerifying">
                {{ isVerifying ? 'Verifying...' : 'Verify & Submit' }}
            </button>
        </div>
    </div>
</div>

<!-- CAMERA MODAL -->
<div class="camera-modal" *ngIf="cameraModalOpen">
    <div class="camera-backdrop" (click)="closeCameraModal()"></div>
    <div class="camera-dialog">
        <h3>Take Photo</h3>
        <div class="camera-preview">
            <video id="verifyCameraVideo" autoplay playsinline *ngIf="!tempImagePreview"></video>
            <img [src]="tempImagePreview" *ngIf="tempImagePreview" class="capture-preview">
        </div>
        <div class="camera-controls">
            <button class="btn" *ngIf="!tempImagePreview" (click)="closeCameraModal()">Cancel</button>
            <button class="btn btn-primary" *ngIf="!tempImagePreview" (click)="takePhoto()">Capture</button>
            
            <button class="btn" *ngIf="tempImagePreview" (click)="retake()">Retake</button>
            <button class="btn btn-primary" *ngIf="tempImagePreview" (click)="savePhoto()">Use Photo</button>
        </div>
    </div>
</div>

<style>
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        max-height: 90vh;
    }

    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #f5f5f7;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .modal-header h3 { margin: 0; font-size: 18px; font-weight: 600; }
    .close-icon { background: none; border: none; font-size: 24px; cursor: pointer; color: #86868b; }

    .modal-body {
        padding: 24px;
        overflow-y: auto;
    }

    .details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 24px;
    }
    .detail-card {
        background: #fbfbfd;
        padding: 16px;
        border-radius: 8px;
        border: 1px solid #e5e5ea;
    }
    .detail-card:last-child { grid-column: span 2; }
    .detail-card h4 { margin: 0 0 12px 0; font-size: 14px; color: #86868b; text-transform: uppercase; letter-spacing: 0.5px; }
    .detail-card p { margin: 4px 0; font-size: 14px; display: flex; justify-content: space-between; }
    .detail-card .label { color: #6e6e73; }
    .detail-card .mono { font-family: monospace; color: #1d1d1f; }
    .detail-card .amount { font-weight: 600; color: #1d1d1f; }
    .status-badge { background: #e5e5ea; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; }

    .duration-controls { display: flex; gap: 12px; margin-bottom: 8px; }
    .duration-input, .duration-select {
        padding: 8px; border: 1px solid #d2d2d7; border-radius: 6px; font-size: 14px;
    }
    .duration-input { width: 80px; }
    .duration-select { flex: 1; }
    .expiry-preview { font-size: 13px; color: #6e6e73; margin: 0; }
    .expiry-preview strong { color: #1d1d1f; }

    .upload-section {
        border-top: 1px solid #f5f5f7;
        padding-top: 20px;
    }
    .upload-section h4 { margin: 0 0 8px 0; font-size: 16px; font-weight: 600; }
    .upload-hint { margin: 0 0 16px 0; font-size: 13px; color: #86868b; }

    .upload-controls {
        display: flex;
        align-items: center;
        gap: 16px;
        background: #f5f5f7;
        padding: 20px;
        border-radius: 8px;
        justify-content: center;
        border: 1px dashed #d2d2d7;
    }
    .btn-upload, .btn-camera {
        background: white;
        border: 1px solid #d2d2d7;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-upload:hover, .btn-camera:hover { border-color: #0071e3; color: #0071e3; }
    .divider { color: #86868b; font-size: 13px; }

    .preview-container {
        position: relative;
        margin-top: 16px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #e5e5ea;
        max-height: 300px;
        display: flex;
        justify-content: center;
        background: #000;
    }
    .preview-container img { max-width: 100%; max-height: 300px; object-fit: contain; }
    .remove-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        background: rgba(0,0,0,0.6);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 12px;
        cursor: pointer;
    }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #f5f5f7;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    .cancel-btn {
        background: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        color: #1d1d1f;
        font-weight: 500;
    }

    .confirm-btn {
        background: #0071e3;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
    }
    .confirm-btn:disabled { background: #99c7f4; cursor: not-allowed; }

    /* Camera Modal Styles */
    .camera-modal { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 2000; }
    .camera-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.8); }
    .camera-dialog { position: relative; background: white; padding: 16px; border-radius: 12px; z-index: 2; width: 400px; max-width: 95%; }
    .camera-preview { position: relative; width: 100%; height: 300px; background: #000; overflow: hidden; border-radius: 8px; display:flex; align-items:center; justify-content:center; margin: 16px 0; }
    .camera-preview video, .capture-preview { width: 100%; height: 100%; object-fit: cover; }
    .camera-controls { display:flex; gap:12px; justify-content:center; }
    .camera-controls .btn { padding: 8px 16px; border-radius:6px; background:#f5f5f7; border:none; cursor: pointer; font-weight: 500; }
    .camera-controls .btn-primary { background: #0071e3; color: white; }

    @media (max-width: 600px) {
        .details-grid { grid-template-columns: 1fr; }
        .detail-card:last-child { grid-column: auto; }
    }
</style>