<div class="notifications-container">

    <!-- LEFT PANEL: USERS LIST -->
    <aside class="users-panel">
        <div class="panel-header">
            Conversations
        </div>

        <ul class="users-list">
            <li *ngIf="isLoadingUsers" class="user-item">
                <div class="loading-text">Loading users...</div>
            </li>

            <li *ngFor="let user of users" class="user-item" [class.active]="selectedUser?.uid === user.uid"
                (click)="selectUser(user)">
                <div class="user-avatar">
                    <img *ngIf="user.avatarDataUrl" [src]="user.avatarDataUrl" alt="{{user.displayName}}">
                    <span *ngIf="!user.avatarDataUrl" class="user-initials">{{getUserInitials(user)}}</span>
                </div>
                <div class="user-info">
                    <p class="user-name">{{user.displayName || user.email || 'Unknown User'}}</p>
                    <p class="last-message">{{user.role || 'Client'}}</p>
                </div>
            </li>

            <li *ngIf="!isLoadingUsers && users.length === 0" class="user-item">
                <div class="loading-text">No users found</div>
            </li>
        </ul>
    </aside>

    <!-- RIGHT PANEL: CHAT -->
    <section class="chat-panel" *ngIf="selectedUser">

        <!-- CHAT HEADER -->
        <header class="chat-header">
            <div class="header-user-avatar">
                <img *ngIf="selectedUser.avatarDataUrl" [src]="selectedUser.avatarDataUrl"
                    alt="{{selectedUser.displayName}}">
                <span *ngIf="!selectedUser.avatarDataUrl" class="user-initials">{{getUserInitials(selectedUser)}}</span>
            </div>
            <div class="header-user-info">
                <p class="header-user-name">{{selectedUser.displayName || selectedUser.email}}</p>
                <p class="header-user-status">{{selectedUser.role || 'User'}}</p>
            </div>
            <!-- Message Filter -->
            <div class="message-filters" *ngIf="selectedUser.uid !== 'system'">
                <button [class.active]="messageFilter === 'all'" (click)="setFilter('all')">All</button>
                <button [class.active]="messageFilter === 'read'" (click)="setFilter('read')">Read</button>
                <button [class.active]="messageFilter === 'unread'" (click)="setFilter('unread')">Unread</button>
            </div>
        </header>

        <!-- CHAT MESSAGES (Scrollable) -->
        <main class="messages-area">
            <div *ngIf="isLoadingMessages" class="loading-text">Loading messages...</div>

            <div *ngIf="!isLoadingMessages && allMessages.length === 0" class="no-messages">
                No messages yet. Start the conversation!
            </div>

            <div *ngIf="!isLoadingMessages && allMessages.length > 0 && filteredMessages.length === 0"
                class="no-messages">
                No {{ messageFilter }} messages found.
            </div>

            <div *ngFor="let message of filteredMessages" class="message-wrapper"
                [class.sent]="message.senderId !== selectedUser.uid"
                [class.received]="message.senderId === selectedUser.uid">
                <div class="message-bubble" [style.background]="message.type === 'invoice' ? '#f5f5f7' : ''"
                    [style.color]="message.type === 'invoice' ? '#1d1d1f' : ''"
                    [style.border]="message.type === 'invoice' ? '1px solid #e5e5ea' : ''">

                    <!-- Invoice Message Type -->
                    <div *ngIf="message.type === 'invoice'; else textMessage" class="invoice-message">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #e5e5ea; padding-bottom: 8px;">
                            <strong style="font-size: 13px;">Invoice
                                #{{message.invoiceData?.id?.substring(0,8)}}</strong>
                            <span
                                style="font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #fef9c3; color: #854d0e;">{{message.invoiceData?.status}}</span>
                        </div>
                        <p style="margin: 0 0 8px 0; font-size: 14px;">{{message.invoiceData?.description ||
                            message.text}}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; font-size: 15px;">{{message.invoiceData?.amount |
                                currency}}</span>
                            <button
                                style="background: #0071e3; color: white; border: none; padding: 4px 12px; border-radius: 12px; font-size: 12px; cursor: pointer;">View</button>
                        </div>
                    </div>

                    <!-- Standard Text Message -->
                    <ng-template #textMessage>
                        <p class="message-text">{{message.text}}</p>
                    </ng-template>

                    <span class="message-time">{{message.timestamp | date:'short'}}</span>
                </div>
            </div>
        </main>

        <!-- MESSAGE INPUT (Sticky at bottom) -->
        <footer class="message-input-footer">
            <input type="text" [(ngModel)]="newMessage" (keyup.enter)="sendMessage()"
                [placeholder]="selectedUser.uid === 'system' ? 'System notifications are read-only' : 'Type a message...'"
                class="message-input" [disabled]="selectedUser.uid === 'system'" />
            <button class="send-button" (click)="sendMessage()"
                [disabled]="!newMessage.trim() || selectedUser.uid === 'system'">
                Send
            </button>
        </footer>

    </section>

    <!-- PLACEHOLDER WHEN NO USER SELECTED -->
    <section class="chat-panel placeholder" *ngIf="!selectedUser">
        <div class="placeholder-content">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="1.5">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <p>Select a conversation to start messaging</p>
        </div>
    </section>
</div>